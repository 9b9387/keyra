!function(e,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((e="undefined"!=typeof globalThis?globalThis:e||self).keyra={})}(this,function(e){"use strict";var r,t={exports:{}};var n=(r||(r=1,function(e){!function(){const r=2147483647;function t(e){const r=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);let t=1779033703,n=3144134277,o=1013904242,s=2773480762,i=1359893119,a=2600822924,l=528734635,u=1541459225;const c=new Uint32Array(64);function h(e){let h=0,f=e.length;for(;f>=64;){let m,p,y,w,g,d=t,b=n,S=o,q=s,N=i,A=a,v=l,$=u;for(p=0;p<16;p++)y=h+4*p,c[p]=(255&e[y])<<24|(255&e[y+1])<<16|(255&e[y+2])<<8|255&e[y+3];for(p=16;p<64;p++)m=c[p-2],w=(m>>>17|m<<15)^(m>>>19|m<<13)^m>>>10,m=c[p-15],g=(m>>>7|m<<25)^(m>>>18|m<<14)^m>>>3,c[p]=(w+c[p-7]|0)+(g+c[p-16]|0)|0;for(p=0;p<64;p++)w=(((N>>>6|N<<26)^(N>>>11|N<<21)^(N>>>25|N<<7))+(N&A^~N&v)|0)+($+(r[p]+c[p]|0)|0)|0,g=((d>>>2|d<<30)^(d>>>13|d<<19)^(d>>>22|d<<10))+(d&b^d&S^b&S)|0,$=v,v=A,A=N,N=q+w|0,q=S,S=b,b=d,d=w+g|0;t=t+d|0,n=n+b|0,o=o+S|0,s=s+q|0,i=i+N|0,a=a+A|0,l=l+v|0,u=u+$|0,h+=64,f-=64}}h(e);let f,m=e.length%64,p=e.length/536870912|0,y=e.length<<3,w=m<56?56:120,g=e.slice(e.length-m,e.length);for(g.push(128),f=m+1;f<w;f++)g.push(0);return g.push(p>>>24&255),g.push(p>>>16&255),g.push(p>>>8&255),g.push(p>>>0&255),g.push(y>>>24&255),g.push(y>>>16&255),g.push(y>>>8&255),g.push(y>>>0&255),h(g),[t>>>24&255,t>>>16&255,t>>>8&255,t>>>0&255,n>>>24&255,n>>>16&255,n>>>8&255,n>>>0&255,o>>>24&255,o>>>16&255,o>>>8&255,o>>>0&255,s>>>24&255,s>>>16&255,s>>>8&255,s>>>0&255,i>>>24&255,i>>>16&255,i>>>8&255,i>>>0&255,a>>>24&255,a>>>16&255,a>>>8&255,a>>>0&255,l>>>24&255,l>>>16&255,l>>>8&255,l>>>0&255,u>>>24&255,u>>>16&255,u>>>8&255,u>>>0&255]}function n(e,r,n){e=e.length<=64?e:t(e);const o=64+r.length+4,s=new Array(o),i=new Array(64);let a,l=[];for(a=0;a<64;a++)s[a]=54;for(a=0;a<e.length;a++)s[a]^=e[a];for(a=0;a<r.length;a++)s[64+a]=r[a];for(a=o-4;a<o;a++)s[a]=0;for(a=0;a<64;a++)i[a]=92;for(a=0;a<e.length;a++)i[a]^=e[a];function u(){for(let e=o-1;e>=o-4;e--){if(s[e]++,s[e]<=255)return;s[e]=0}}for(;n>=32;)u(),l=l.concat(t(i.concat(t(s)))),n-=32;return n>0&&(u(),l=l.concat(t(i.concat(t(s))).slice(0,n))),l}function o(e,r,t,n,o){let s;for(l(e,16*(2*t-1),o,0,16),s=0;s<2*t;s++)a(e,16*s,o,16),i(o,n),l(o,0,e,r+16*s,16);for(s=0;s<t;s++)l(e,r+2*s*16,e,16*s,16);for(s=0;s<t;s++)l(e,r+16*(2*s+1),e,16*(s+t),16)}function s(e,r){return e<<r|e>>>32-r}function i(e,r){l(e,0,r,0,16);for(let e=8;e>0;e-=2)r[4]^=s(r[0]+r[12],7),r[8]^=s(r[4]+r[0],9),r[12]^=s(r[8]+r[4],13),r[0]^=s(r[12]+r[8],18),r[9]^=s(r[5]+r[1],7),r[13]^=s(r[9]+r[5],9),r[1]^=s(r[13]+r[9],13),r[5]^=s(r[1]+r[13],18),r[14]^=s(r[10]+r[6],7),r[2]^=s(r[14]+r[10],9),r[6]^=s(r[2]+r[14],13),r[10]^=s(r[6]+r[2],18),r[3]^=s(r[15]+r[11],7),r[7]^=s(r[3]+r[15],9),r[11]^=s(r[7]+r[3],13),r[15]^=s(r[11]+r[7],18),r[1]^=s(r[0]+r[3],7),r[2]^=s(r[1]+r[0],9),r[3]^=s(r[2]+r[1],13),r[0]^=s(r[3]+r[2],18),r[6]^=s(r[5]+r[4],7),r[7]^=s(r[6]+r[5],9),r[4]^=s(r[7]+r[6],13),r[5]^=s(r[4]+r[7],18),r[11]^=s(r[10]+r[9],7),r[8]^=s(r[11]+r[10],9),r[9]^=s(r[8]+r[11],13),r[10]^=s(r[9]+r[8],18),r[12]^=s(r[15]+r[14],7),r[13]^=s(r[12]+r[15],9),r[14]^=s(r[13]+r[12],13),r[15]^=s(r[14]+r[13],18);for(let t=0;t<16;++t)e[t]+=r[t]}function a(e,r,t,n){for(let o=0;o<n;o++)t[o]^=e[r+o]}function l(e,r,t,n,o){for(;o--;)t[n++]=e[r++]}function u(e){if(!e||"number"!=typeof e.length)return!1;for(let r=0;r<e.length;r++){const t=e[r];if("number"!=typeof t||t%1||t<0||t>=256)return!1}return!0}function c(e,r){if("number"!=typeof e||e%1)throw new Error("invalid "+r);return e}function h(e,t,s,i,h,f,m){if(s=c(s,"N"),i=c(i,"r"),h=c(h,"p"),f=c(f,"dkLen"),0===s||s&s-1)throw new Error("N must be power of 2");if(s>r/128/i)throw new Error("N too large");if(i>r/128/h)throw new Error("r too large");if(!u(e))throw new Error("password must be an array or buffer");if(e=Array.prototype.slice.call(e),!u(t))throw new Error("salt must be an array or buffer");t=Array.prototype.slice.call(t);let p=n(e,t,128*h*i);const y=new Uint32Array(32*h*i);for(let e=0;e<y.length;e++){const r=4*e;y[e]=(255&p[r+3])<<24|(255&p[r+2])<<16|(255&p[r+1])<<8|255&p[r+0]}const w=new Uint32Array(64*i),g=new Uint32Array(32*i*s),d=32*i,b=new Uint32Array(16),S=new Uint32Array(16),q=h*s*2;let N,A,v=0,$=null,U=!1,E=0,x=0;const F=m?parseInt(1e3/i):4294967295,L="undefined"!=typeof setImmediate?setImmediate:setTimeout,R=function(){if(U)return m(new Error("cancelled"),v/q);let r;switch(E){case 0:A=32*x*i,l(y,A,w,0,d),E=1,N=0;case 1:r=s-N,r>F&&(r=F);for(let e=0;e<r;e++)l(w,0,g,(N+e)*d,d),o(w,d,i,b,S);if(N+=r,v+=r,m){const e=parseInt(1e3*v/q);if(e!==$){if(U=m(null,v/q),U)break;$=e}}if(N<s)break;N=0,E=2;case 2:r=s-N,r>F&&(r=F);for(let e=0;e<r;e++){const e=w[16*(2*i-1)]&s-1;a(g,e*d,w,d),o(w,d,i,b,S)}if(N+=r,v+=r,m){const e=parseInt(1e3*v/q);if(e!==$){if(U=m(null,v/q),U)break;$=e}}if(N<s)break;if(l(w,0,y,A,d),x++,x<h){E=0;break}p=[];for(let e=0;e<y.length;e++)p.push(255&y[e]),p.push(y[e]>>8&255),p.push(y[e]>>16&255),p.push(y[e]>>24&255);const t=n(e,p,f);return m&&m(null,1,t),t}m&&L(R)};if(!m)for(;;){const e=R();if(null!=e)return e}R()}const f={scrypt:function(e,r,t,n,o,s,i){return new Promise(function(a,l){let u=0;i&&i(0),h(e,r,t,n,o,s,function(e,r,t){if(e)l(e);else if(t)i&&1!==u&&i(1),a(new Uint8Array(t));else if(i&&r!==u)return u=r,i(r)})})},syncScrypt:function(e,r,t,n,o,s){return new Uint8Array(h(e,r,t,n,o,s))}};e.exports=f}()}(t)),t.exports);class o{constructor(e="",r=s.length,t=s.requireUppercase,n=s.requireLowercase,o=s.requireNumbers,i=s.requireSymbols,a=s.allowedSymbols){this.name=e,this.length=r,this.requireUppercase=t,this.requireLowercase=n,this.requireNumbers=o,this.requireSymbols=i,this.allowedSymbols=a}validate(){return this.length<4?(console.error("Minimum length cannot be less than 4"),!1):this.length>4096?(console.error("Maximum length cannot exceed 4096"),!1):!!/^[\x20-\x7E]*$/.test(this.allowedSymbols)||(console.error("Allowed symbols must only contain ASCII characters"),!1)}serialize(){return JSON.stringify(this)}static deserialize(e){try{const r=JSON.parse(e);return new o(r.name,r.length,r.requireUppercase,r.requireLowercase,r.requireNumbers,r.requireSymbols,r.allowedSymbols)}catch(e){console.error(`Failed to parse KeyraRule from JSON: ${e}`)}return s}toString(){return`Rule: ${this.name}\n    ├─ Length    : ${this.length}\n    ├─ Require uppercase : ${this.requireUppercase?"Yes":"No"}\n    ├─ Require lowercase : ${this.requireLowercase?"Yes":"No"}\n    ├─ Require numbers   : ${this.requireNumbers?"Yes":"No"}\n    ├─ Require symbols   : ${this.requireSymbols?"Yes":"No"}\n    └─ Allowed symbols   : ${this.requireSymbols?this.allowedSymbols:"None"}`}}const s=new o("default",16,!0,!0,!0,!0,"!@#$%^&*()_+-=[]{}|;:,.<>?");class i{constructor(e,r=1,t=s,n="",o=new Date,i=""){this.serviceName=e,this.version=r,this.rule=t,this.note=n,this.createDate=o,this.domain=i}serialize(){return JSON.stringify(this)}static deserialize(e){try{const r=JSON.parse(e),t=JSON.stringify(r.rule);return new i(r.serviceName,r.version,o.deserialize(t),r.note,new Date(r.createDate),r.domain)}catch(e){console.error(`Failed to deserialize KeyraData: ${e}`)}return null}toString(){return`Service: ${this.serviceName}\n    ├─ Version     : ${this.version}\n    ├─ Rule        : ${this.rule.name};\n    ├─ Create Date : ${this.createDate.toLocaleString()}\n    ├─ Domain      : ${this.domain||"None"}\n    └─ Note        : ${this.note||"None"}`}}e.DEFAULT_RULE=s,e.Generator=class{async generateSufficientHash(e,r,t,o){const s=new TextEncoder,i=s.encode(e),a=s.encode(`keyra|${r}|${t}`);return await n.scrypt(i,a,16384,8,1,o)}async generatePasswordFromHash(e,r){if(!e||!(e instanceof Uint8Array)||e.length<r.length)throw new Error("Hash must be a valid Uint8Array with length at least equal to the password length.");if(!(r&&r instanceof o))throw new Error("Rule must be a valid KeyraRule instance");const t="ABCDEFGHIJKLMNOPQRSTUVWXYZ",n="abcdefghijklmnopqrstuvwxyz",s="0123456789",i=Array.from(new Set(r.allowedSymbols)).sort().join("");let a="";if(r.requireUppercase&&(a+=t),r.requireLowercase&&(a+=n),r.requireNumbers&&(a+=s),r.requireSymbols&&(a+=i),0===a.length)throw new Error("No available characters for password generation. Please enable at least one character type.");const l=[];let u=0;const c=()=>e[u++%e.length];if(r.requireUppercase&&l.push(this.selectCharFromSet(c,t)),r.requireLowercase&&l.push(this.selectCharFromSet(c,n)),r.requireNumbers&&l.push(this.selectCharFromSet(c,s)),r.requireSymbols&&i.length>0&&l.push(this.selectCharFromSet(c,i)),r.length<l.length)throw new Error(`Password length (${r.length}) must be at least ${l.length} to accommodate required character types`);const h=r.length-l.length;for(let e=0;e<h;e++)l.push(this.selectCharFromSet(c,a));return this.shuffleArray(l,e,u),l.join("")}async generate(e,r){if(!e||"string"!=typeof e)return console.error("Master password must be a non-empty string"),"";if(!r.serviceName||"string"!=typeof r.serviceName)return console.error("Service name must be a non-empty string"),"";if(!1===r.rule.validate())return console.error("Invalid password rule"),"";const t=r.rule.length,n=r.version||1,o=r.serviceName,s=await this.generateSufficientHash(e,o,n,t);return await this.generatePasswordFromHash(s,r.rule)}selectCharFromSet(e,r){const t=r.length;if(t<=0)throw new Error("Empty charset");const n=Math.floor(256/t)*t;for(;;){const o=e();if(o<n)return r[o%t]}}shuffleArray(e,r,t){let n=t;for(let t=e.length-1;t>0;t--){const o=(r[n++%r.length]<<8|r[n++%r.length])%(t+1);[e[t],e[o]]=[e[o],e[t]]}return n}},e.KeyraData=i,e.KeyraRule=o});
